name: Merge & Test Alive Nodes

on:
  schedule:
    - cron: '30 7 * * *'
  workflow_dispatch:

concurrency:
  group: merge-test
  cancel-in-progress: true

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp pyyaml

      - name: Download latest sing-box
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          wget -O sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/${LATEST_TAG}/sing-box-${LATEST_TAG#v}-linux-amd64.tar.gz"
          tar -xzf sing-box.tar.gz --strip-components=1 "sing-box-${LATEST_TAG#v}-linux-amd64/sing-box"
          chmod +x sing-box
          ./sing-box version

      - name: Run merge and sing-box test
        run: python merge_and_test.py

      - name: Commit and push if changed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add alive.txt
          git diff --staged --quiet || git commit -m "Update alive nodes (sing-box test) $(date +'%Y-%m-%d %H:%M UTC')"

          git pull --rebase
          git push || echo "No changes"
